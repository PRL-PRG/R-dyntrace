cmake_minimum_required(VERSION 3.0)
project(rdt_promises)

set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR})
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++14 -g3 -ggdb")

# This is not ideal. Our build now depends on config.h generated by R's configure.
# If we wanted to use cmake exclusively though, we would
# have to recreate all the autoconf checks that GNU R performs.
add_definitions(-DHAVE_CONFIG_H)


# Find SQLITE:

# Look for the header file.
find_path(SQLITE3_INCLUDE_DIR NAMES sqlite3.h)

# Look for the library.
find_library(SQLITE3_LIBRARY NAMES sqlite3)


set(SOURCE_FILES
    src/utilities.hpp
    src/utilities.cpp
    src/hooks.hpp
    src/hooks.cpp
    src/globals.hpp
    src/globals.cpp
    src/tracer.cpp
    src/tracer.hpp
    src/recorder.hpp
    src/recorder.cpp
    src/State.hpp
    src/State.cpp
    src/SqlSerializer.hpp
    src/SqlSerializer.cpp
    src/helpers.cpp)

# R include paths (in our R-dyntrace repo)
include_directories(../../src/library/rdt/src)
include_directories(../../src/main)
include_directories(../../include)
include_directories(../../include/R_ext)
include_directories(../../src/include)
include_directories(../../src/include/R_ext)
include_directories(../../src/include/Rmodules)
include_directories(../../src/include/vg)

# Include SQLITE
include_directories(SQLITE3_INCLUDE_DIR)

# Add library target
add_library(rdt_promises SHARED ${SOURCE_FILES})

# Link SQLITE
target_link_libraries(rdt_promises ${SQLITE3_LIBRARY})

# This tells the linker not to complain about undefined symbols
# which are from the loader module (R in this case).
# It's needed because this is a plugin library that will call
# back to R API but we cannot link against it at compile time.
if(CMAKE_CXX_COMPILER_ID MATCHES "Clang")
    message(STATUS "Setting '-undefined dynamic_lookup' for clang")
    set(CMAKE_SHARED_LIBRARY_CREATE_CXX_FLAGS "${CMAKE_SHARED_LIBRARY_CREATE_CXX_FLAGS} -undefined dynamic_lookup")
endif()
