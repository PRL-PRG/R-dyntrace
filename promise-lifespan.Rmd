---
params: 
    title: "?"
    dbpath: "?"
title: "`r params$title`"
date: "`r Sys.Date()`"
output: html_document
---
<style>
    body .main-container {
        max-width: 2000px;
    }
</style>

```{r libraries, include=FALSE}
library(dplyr)
library(dbplyr)
library(ggplot2)
library(ggthemes)
library(knitr)
library(tidyr)
```

```{r utility, include=FALSE}
typename <- function(type) {
    switch(toString(type),
           "0" = "NIL",
           "1" = "SYM",
           "2" = "LIST",
           "3" = "CLO",
           "4" = "ENV",
           "5" = "PROM",
           "6" = "LANG",
           "7" = "SPECIAL",
           "8" = "BUILTIN",
           "9" = "CHAR",
           "10" = "LGL",
           "13" = "INT",
           "14" = "REAL",
           "15" = "CPLX",
           "16" = "STR",
           "17" = "DOT",
           "18" = "ANY",
           "19" = "VEC",
           "20" = "EXPR",
           "21" = "BCODE",
           "22" = "EXTPTR",
           "23" = "WEAKREF",
           "24" = "RAW",
           "25" = "S4",
           "30" = "NEW",
           "31" = "FREE",
           "99" = "FUN",
           "?")
}

eventname <- function(event) {
    switch(toString(event),
           "0" = "CREATED",
           "1" = "LOOKED UP",
           "2" = "GARBAGE COLLECTED",
           "?")
}
```

```{r, include = FALSE}
opts_chunk$set(comment=NA, fig.width=22, fig.height=12)
```


```{r ggplot_theme, include = FALSE}
promise_theme <- 
    theme_minimal() +
    theme(plot.title =element_text(size = 30, face="bold", hjust = 0.5, lineheight = 4, margin = margin(t = 0, r = 0, b = 20, l = 0)),
          axis.text = element_text(size=15),
          axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5), 
          axis.title = element_text(size=20, face="bold", hjust = 0.5),
          axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
          axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))

# Set promise_theme as the default theme. Store previous theme.
previous_theme <- theme_set(promise_theme)
```

```{r tables, include=FALSE}
db <- src_sqlite(params$dbpath)
functions <- db %>% tbl("functions")
arguments <- db %>% tbl("arguments")
calls <- db %>% tbl("calls")
promises <- db %>% tbl("promises")
associations <- db %>% tbl("promise_associations")
evaluations <- db %>% tbl("promise_evaluations")
lifecycle <-
    db %>%
    tbl("promise_lifecycle") %>%
    group_by(promise_id, event_type) %>%
    summarize(gc_trigger_counter = max(gc_trigger_counter))

trigger <- db %>% tbl("gc_trigger")
type_distribution <- db %>% tbl("type_distribution")
```


```{r promise_garbage_collection, echo = FALSE, eval = TRUE}
data <-
    lifecycle %>%
    filter(event_type != 1) %>%
    group_by(gc_trigger_counter, event_type) %>%
    summarize(promises = count(promise_id)) %>%
    collect() %>%
    rowwise() %>%
    mutate(event_type = eventname(event_type)) %>%
    spread(event_type, promises) %>%
    mutate(CREATED = ifelse(is.na(CREATED),0,CREATED), `GARBAGE COLLECTED` = ifelse(is.na(`GARBAGE COLLECTED`),0, `GARBAGE COLLECTED`)) %>%
    mutate(ALIVE = cumsum(CREATED) - cumsum(`GARBAGE COLLECTED`)) %>%
    mutate(ALIVE = c(0, head(ALIVE, -1))) %>%
    tail(-1) %>%
    head(-1)
    

knitr::kable(data)

min_trigger <- min(data$gc_trigger_counter, na.rm = TRUE)
max_trigger <- max(data$gc_trigger_counter, na.rm = TRUE)

graph <-
    data %>%
    select(gc_trigger_counter, ALIVE, `GARBAGE COLLECTED`) %>%
    gather(`PROMISE TYPE`, promises, -gc_trigger_counter) %>%
    ggplot(aes(gc_trigger_counter, promises, group = `PROMISE TYPE`)) +
    geom_bar(aes(fill = `PROMISE TYPE`), stat = "identity", position = "dodge") +
    ggtitle("Promise Garbage Collection",
            "Number of promises collected at each GC trigger") +
    xlab("GC Trigger") +
    ylab("Number of Promises") +
    #scale_x_continuous(breaks = seq(min_trigger, max_trigger, 5),
                       #minor_breaks = c((min_trigger - 1) : (max_trigger + 1)),
                       #limits = c(min_trigger - 1, max_trigger + 1)) +
    scale_fill_gdocs()

graph
```
